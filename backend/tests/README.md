# E2E Tests

Этот файл содержит end-to-end тесты для проверки полного функционала создания заведения.

## Быстрый старт

### Полная последовательность запуска:

```bash
# Шаг 1: Убедитесь, что сервер и БД запущены
docker-compose ps  # проверка статуса
# Если не запущены: docker-compose up -d

# Шаг 2: Засеять начальные данные (роли, подписки, вопросы)
# ⚠️  ВАЖНО: Скрипты автоматически создадут таблицы, если их нет (AutoMigrate)
cd backend

# 2.1. Засеять роли и подписки (создаст таблицы roles и subscription_plans)
go run internal/scripts/seed_roles_and_subscriptions.go
# ✅ Убедитесь, что в конце вы видите: "✅ Owner role verified"

# 2.2. Засеять вопросы onboarding (создаст таблицы onboarding_questions и question_options)
go run internal/scripts/seed_onboarding_questions.go
# ✅ Убедитесь, что в конце вы видите: "✅ Questions verified successfully"

# Шаг 3: Запустить e2e тест (после скриптов можно сразу запускать!)
cd tests
go test -v -short=false -run TestEstablishmentCreationE2E ./e2e_test.go
```

**✅ После выполнения скриптов можно сразу запускать тесты!**

## Подготовка перед запуском тестов

Перед запуском e2e тестов необходимо засеять начальные данные в базу данных:

### 1. Засеять роли и подписки

**Важно:** Перед запуском скриптов убедитесь, что PostgreSQL запущен и доступен.

Если вы используете docker-compose, PostgreSQL доступен на порту **15432** (внешний порт).

```bash
cd backend

# Скрипты автоматически используют настройки по умолчанию:
# - DB_HOST=localhost
# - DB_PORT=15432 (настроено в config.go для docker-compose)
# - DB_USER=arc_user
# - DB_PASSWORD=arc_password
# - DB_NAME=arc_db

# Если нужно изменить настройки, установите переменные окружения:
# export DB_PORT=5432  # для другого порта
# export DB_PASSWORD=your_password  # для другого пароля

# Запустите скрипт
go run internal/scripts/seed_roles_and_subscriptions.go
```

Скрипт автоматически:
- Загружает конфигурацию из переменных окружения или .env файла
- Подключается к базе данных
- **Автоматически создает таблицы** (использует GORM AutoMigrate для `roles`, `subscription_plans`, `users`)
- Создает необходимые роли (если их еще нет):
  - `owner` - роль владельца заведения
  - `manager` - роль менеджера
  - `waiter` - роль официанта
  - `cook` - роль повара
- Создает планы подписки (если их еще нет):
  - `Free Trial` - бесплатный пробный период (14 дней)

**Примечание:** Скрипт проверяет существование записей перед созданием, поэтому его можно запускать многократно. Таблицы создаются автоматически, если их нет.

### 2. Засеять вопросы onboarding

```bash
cd backend

# Убедитесь, что переменные окружения установлены (см. выше)
go run internal/scripts/seed_onboarding_questions.go
```

Скрипт автоматически:
- Загружает конфигурацию из переменных окружения или .env файла
- Подключается к базе данных
- **Автоматически создает таблицы** (использует GORM AutoMigrate для `onboarding_questions`, `question_options`)
- Создает вопросы onboarding (если их еще нет)

**Примечание:** Скрипт проверяет существование вопросов перед созданием, поэтому его можно запускать многократно. Таблицы создаются автоматически, если их нет.

### Альтернатива: Создание .env файла

Если нужно использовать другие настройки, вы можете создать файл `.env` в корне проекта (`/Users/ad/Desktop/arc/.env`) со следующим содержимым:

```env
DB_HOST=localhost
DB_PORT=15432
DB_USER=arc_user
DB_PASSWORD=arc_password
DB_NAME=arc_db
DB_SSLMODE=disable
```

Скрипты автоматически загрузят эти настройки через `godotenv.Load()`.

**Примечание:** По умолчанию скрипты уже настроены на работу с docker-compose (порт 15432), поэтому .env файл не обязателен, если вы используете стандартные настройки.

## Запуск тестов

### Требования (проверьте перед запуском)

1. ✅ **Сервер должен быть запущен** на `http://localhost:8080`
2. ✅ **База данных должна быть настроена** и доступна
3. ✅ **Все миграции применены**
4. ✅ **Seed данные засеяны** (роли, подписки, вопросы onboarding) - **обязательно!**

**Важно:** Тесты **не будут работать** без засеянных данных. Обязательно выполните скрипты из раздела "Подготовка" перед запуском тестов.

### Команда запуска

```bash
cd backend/tests
go test -v -short=false -run TestEstablishmentCreationE2E ./e2e_test.go
```

### Что проверяет тест

Тест проходит через полный цикл создания заведения:

1. ✅ Регистрация пользователя
2. ✅ Получение вопросов onboarding
3. ✅ Отправка ответов onboarding (создание заведения)
4. ✅ Получение заведения
5. ✅ Создание категорий (ингредиентов, товаров, тех-карт)
6. ✅ Создание склада
7. ✅ Создание поставщика
8. ✅ Создание ингредиентов с остатками
9. ✅ Создание товаров с остатками
10. ✅ Создание тех-карт с ингредиентами
11. ✅ Проверка остатков на складе
12. ✅ Создание поставки
13. ✅ Проверка остатков после поставки
14. ✅ Создание списания
15. ✅ Проверка остатков после списания
16. ✅ Получение движений по складу
17. ✅ Финальная проверка всех созданных сущностей

## Решение проблем

### Ошибка: "owner role not found, please seed roles first"

**Решение:** 

1. Запустите скрипт для засеивания ролей (он автоматически создаст таблицы):
```bash
cd backend
go run internal/scripts/seed_roles_and_subscriptions.go
```

2. **Проверьте вывод скрипта** - вы должны увидеть:
   - `✅ Successfully connected to database`
   - `Running database migrations (AutoMigrate)...`
   - `✅ Database migrations completed`
   - `Created role: owner` (или `Role 'owner' already exists`)
   - `✅ Owner role verified: ID=...`

3. Если скрипт показывает ошибки `relation "roles" does not exist`:
   - Это означает, что AutoMigrate не сработал
   - Проверьте подключение к БД в выводе: `Connecting to database: ...`
   - Убедитесь, что PostgreSQL запущен: `docker-compose ps`

4. Если скрипт выполнился успешно, но тест все еще падает:
   - Убедитесь, что сервер использует ту же БД (проверьте переменные окружения)
   - Возможно, нужно перезапустить сервер после засеивания данных

### Ошибка: "failed to get questions"

**Решение:**

1. Запустите скрипт для засеивания вопросов onboarding:
```bash
cd backend
go run internal/scripts/seed_onboarding_questions.go
```

2. **Проверьте вывод скрипта** - вы должны увидеть:
   - `✅ Successfully connected to database`
   - `Created question: establishment_name` (или `Question 'establishment_name' already exists`)
   - `✅ Questions verified successfully`

3. Если скрипт показывает ошибки, см. решение выше для ролей.

### Ошибка: "invalid authorization header format"

**Причина:** Это происходит, когда предыдущий шаг (регистрация) не удался, и токен остался пустым.

**Решение:** Убедитесь, что:
1. Роли засеяны (см. выше)
2. Сервер запущен и доступен
3. База данных настроена правильно

### Ошибка: "Server is not running"

**Решение:** Запустите сервер:
```bash
cd backend
go run cmd/api/main.go
```

Или через Makefile:
```bash
make run
```

## Статистика

После успешного выполнения теста выводится статистика:
- Количество созданных сущностей
- ID созданных сущностей (для отладки)

## Примечания

- Тест использует уникальные email адреса для каждого запуска
- Тест проверяет, что сервер запущен перед началом
- Все проверки используют стандартный пакет `testing` без внешних зависимостей
- Тест можно запускать многократно - каждый раз создаются новые данные
- При ошибках тест останавливается с детальными сообщениями
